<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FORGE | Multi-Model Adversarial Code Arena</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ============================================================
   FORGE - Cyberpunk Dashboard
   A multi-model adversarial code arena interface
   ============================================================ */

/* --- Reset & Foundation --- */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --bg-deep: #08080f;
  --bg-card: #0d1117;
  --bg-card-hover: #111820;
  --bg-surface: #161b22;
  --bg-input: #0a0e14;
  --border-dim: #1a1f2b;
  --border-glow: #2a3040;
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-dim: #484f58;

  --cyan: #00f0ff;
  --cyan-dim: #00f0ff40;
  --cyan-glow: 0 0 20px #00f0ff60, 0 0 40px #00f0ff20;
  --magenta: #ff00aa;
  --magenta-dim: #ff00aa40;
  --magenta-glow: 0 0 20px #ff00aa60, 0 0 40px #ff00aa20;
  --yellow: #f0ff00;
  --yellow-dim: #f0ff0040;
  --yellow-glow: 0 0 20px #f0ff0060, 0 0 40px #f0ff0020;
  --green: #00ff88;
  --green-dim: #00ff8840;
  --green-glow: 0 0 20px #00ff8860, 0 0 40px #00ff8820;

  --font-sans: 'Inter', -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;

  --radius: 8px;
  --radius-lg: 12px;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

html {
  font-size: 14px;
  scroll-behavior: smooth;
}

body {
  font-family: var(--font-sans);
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.6;
}

/* --- Grid Background Pattern --- */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0, 240, 255, 0.05) 0%, transparent 60%),
              radial-gradient(ellipse 60% 40% at 80% 100%, rgba(255, 0, 170, 0.04) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

#app {
  position: relative;
  z-index: 1;
  max-width: 1920px;
  margin: 0 auto;
  padding: 0 24px 24px;
}

/* --- Scrollbar --- */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-deep); }
::-webkit-scrollbar-thumb { background: var(--border-glow); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

/* --- Animations --- */
@keyframes pulse-glow {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

@keyframes scan-line {
  0% { transform: translateY(-100%); }
  100% { transform: translateY(100vh); }
}

@keyframes slide-up {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slide-in-left {
  from { opacity: 0; transform: translateX(-30px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes slide-in-right {
  from { opacity: 0; transform: translateX(30px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes border-pulse {
  0%, 100% { border-color: var(--pulse-color, var(--cyan-dim)); }
  50% { border-color: var(--pulse-color-bright, var(--cyan)); }
}

@keyframes score-fill {
  from { width: 0%; }
}

@keyframes confetti-fall {
  0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

@keyframes winner-glow {
  0%, 100% { box-shadow: 0 0 30px var(--winner-color, var(--cyan)), inset 0 0 30px rgba(0,0,0,0.5); }
  50% { box-shadow: 0 0 60px var(--winner-color, var(--cyan)), 0 0 100px var(--winner-color, var(--cyan))40, inset 0 0 30px rgba(0,0,0,0.5); }
}

@keyframes typing {
  from { width: 0; }
  to { width: 100%; }
}

@keyframes blink-caret {
  0%, 100% { border-color: transparent; }
  50% { border-color: var(--cyan); }
}

@keyframes vs-pulse {
  0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.9; }
  50% { transform: translate(-50%, -50%) scale(1.15); opacity: 1; }
}

@keyframes shimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}

@keyframes toast-in {
  from { transform: translateX(120%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes toast-out {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(120%); opacity: 0; }
}

.animate-slide-up {
  animation: slide-up 0.5s var(--transition) both;
}

/* --- Top Bar --- */
#topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 0;
  border-bottom: 1px solid var(--border-dim);
  margin-bottom: 24px;
  position: relative;
}

#topbar::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--cyan-dim), var(--magenta-dim), transparent);
}

.logo-group {
  display: flex;
  align-items: baseline;
  gap: 16px;
}

.logo {
  font-family: var(--font-mono);
  font-size: 2.4rem;
  font-weight: 900;
  letter-spacing: 6px;
  color: var(--cyan);
  text-shadow: var(--cyan-glow), 0 0 60px #00f0ff10;
  text-transform: uppercase;
  position: relative;
}

.logo::before {
  content: 'FORGE';
  position: absolute;
  left: 2px;
  top: 2px;
  color: var(--magenta);
  opacity: 0.3;
  z-index: -1;
  filter: blur(1px);
}

.subtitle {
  font-size: 0.85rem;
  color: var(--text-secondary);
  font-weight: 300;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.connection-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.8rem;
  color: var(--text-dim);
  font-family: var(--font-mono);
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-dim);
  transition: var(--transition);
}

.status-dot.connected {
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
  animation: pulse-glow 2s ease-in-out infinite;
}

.status-dot.disconnected {
  background: #ff4444;
  box-shadow: 0 0 8px #ff4444;
}

/* --- Challenge Form --- */
#challenge-form {
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-lg);
  margin-bottom: 24px;
  overflow: hidden;
  transition: var(--transition);
}

.form-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  cursor: pointer;
  user-select: none;
  transition: var(--transition);
}

.form-header:hover {
  background: var(--bg-card-hover);
}

.form-header h2 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-header h2 .icon {
  color: var(--cyan);
  font-size: 1.2rem;
}

.form-toggle {
  color: var(--text-dim);
  font-size: 1.2rem;
  transition: transform 0.3s ease;
}

.form-toggle.collapsed {
  transform: rotate(-90deg);
}

.form-body {
  padding: 0 24px 24px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  max-height: 600px;
  overflow: hidden;
  transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.3s ease;
  opacity: 1;
}

.form-body.collapsed {
  max-height: 0;
  padding-top: 0;
  padding-bottom: 0;
  opacity: 0;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-secondary);
}

.form-group input,
.form-group textarea,
.form-group select {
  background: var(--bg-input);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius);
  padding: 10px 14px;
  color: var(--text-primary);
  font-family: var(--font-sans);
  font-size: 0.9rem;
  transition: var(--transition);
  outline: none;
}

.form-group textarea {
  font-family: var(--font-mono);
  font-size: 0.82rem;
  resize: vertical;
  min-height: 100px;
  line-height: 1.5;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  border-color: var(--cyan);
  box-shadow: 0 0 0 3px var(--cyan-dim), inset 0 0 10px rgba(0, 240, 255, 0.05);
}

.form-group select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b949e' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}

.form-actions {
  grid-column: 1 / -1;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  align-items: center;
  padding-top: 8px;
}

.btn {
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 0.85rem;
  padding: 10px 24px;
  border-radius: var(--radius);
  border: 1px solid var(--border-dim);
  cursor: pointer;
  transition: var(--transition);
  text-transform: uppercase;
  letter-spacing: 2px;
  position: relative;
  overflow: hidden;
}

.btn-secondary {
  background: var(--bg-surface);
  color: var(--text-secondary);
  border-color: var(--border-glow);
}

.btn-secondary:hover {
  background: var(--bg-card-hover);
  color: var(--text-primary);
  border-color: var(--text-dim);
}

.btn-primary {
  background: linear-gradient(135deg, #00f0ff15, #ff00aa15);
  color: var(--cyan);
  border-color: var(--cyan-dim);
  text-shadow: 0 0 10px var(--cyan-dim);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #00f0ff25, #ff00aa25);
  border-color: var(--cyan);
  box-shadow: var(--cyan-glow), inset 0 0 20px rgba(0, 240, 255, 0.05);
  transform: translateY(-1px);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-primary.loading {
  pointer-events: none;
  opacity: 0.7;
}

.btn-primary.loading::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.2), transparent);
  animation: shimmer 1.5s infinite;
  background-size: 200% 100%;
}

/* --- Arena Container --- */
#arena-container {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 24px;
  margin-bottom: 24px;
}

/* --- Arena Grid --- */
#arena {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  position: relative;
  min-height: 500px;
}

/* --- VS Badge --- */
#vs-badge {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: radial-gradient(circle, var(--bg-deep) 40%, transparent 70%);
  border: 2px solid var(--magenta);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 1.4rem;
  font-weight: 900;
  color: var(--magenta);
  text-shadow: var(--magenta-glow);
  z-index: 10;
  pointer-events: none;
  opacity: 0;
  transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
}

#vs-badge.active {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
  animation: vs-pulse 2s ease-in-out infinite;
}

/* --- Solution Panels --- */
.solution-panel {
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: var(--transition);
  display: flex;
  flex-direction: column;
  position: relative;
}

.solution-panel::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--accent);
  opacity: 0.6;
  transition: opacity var(--transition);
}

.solution-panel:hover::before {
  opacity: 1;
}

.solution-panel[data-perspective="architect"] {
  --accent: var(--cyan);
  --accent-dim: var(--cyan-dim);
  --accent-glow: var(--cyan-glow);
  --pulse-color: var(--cyan-dim);
  --pulse-color-bright: var(--cyan);
}

.solution-panel[data-perspective="hacker"] {
  --accent: var(--magenta);
  --accent-dim: var(--magenta-dim);
  --accent-glow: var(--magenta-glow);
  --pulse-color: var(--magenta-dim);
  --pulse-color-bright: var(--magenta);
}

.solution-panel[data-perspective="scientist"] {
  --accent: var(--yellow);
  --accent-dim: var(--yellow-dim);
  --accent-glow: var(--yellow-glow);
  --pulse-color: var(--yellow-dim);
  --pulse-color-bright: var(--yellow);
}

.solution-panel[data-perspective="pragmatist"] {
  --accent: var(--green);
  --accent-dim: var(--green-dim);
  --accent-glow: var(--green-glow);
  --pulse-color: var(--green-dim);
  --pulse-color-bright: var(--green);
}

.solution-panel.generating {
  animation: border-pulse 1.5s ease-in-out infinite;
  border-color: var(--accent-dim);
}

.solution-panel.winner {
  --winner-color: var(--accent);
  animation: winner-glow 2s ease-in-out infinite;
  border-color: var(--accent);
}

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  border-bottom: 1px solid var(--border-dim);
  background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
}

.panel-identity {
  display: flex;
  align-items: center;
  gap: 10px;
}

.panel-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  background: var(--accent-dim);
  border: 1px solid var(--accent);
  color: var(--accent);
  text-shadow: 0 0 10px var(--accent);
  flex-shrink: 0;
}

.panel-name {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--accent);
  text-shadow: 0 0 10px var(--accent-dim);
}

.panel-status {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dim);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: var(--transition);
}

.panel-status .status-indicator {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-dim);
  transition: var(--transition);
}

.panel-status.waiting .status-indicator { background: var(--text-dim); }
.panel-status.generating .status-indicator { background: var(--accent); animation: pulse-glow 1s ease-in-out infinite; box-shadow: 0 0 6px var(--accent); }
.panel-status.reviewing .status-indicator { background: var(--yellow); animation: pulse-glow 1s ease-in-out infinite; box-shadow: 0 0 6px var(--yellow); }
.panel-status.done .status-indicator { background: var(--green); box-shadow: 0 0 6px var(--green); }
.panel-status.error .status-indicator { background: #ff4444; box-shadow: 0 0 6px #ff4444; }

.panel-code {
  flex: 1;
  padding: 14px 18px;
  overflow: auto;
  max-height: 300px;
  min-height: 180px;
  position: relative;
}

.panel-code pre {
  font-family: var(--font-mono);
  font-size: 0.78rem;
  line-height: 1.7;
  color: var(--text-primary);
  white-space: pre;
  tab-size: 4;
  margin: 0;
}

.panel-code .placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  min-height: 150px;
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 0.8rem;
  gap: 12px;
}

.placeholder-icon {
  font-size: 2rem;
  opacity: 0.3;
}

.spinner {
  width: 24px;
  height: 24px;
  border: 2px solid var(--border-dim);
  border-top-color: var(--accent, var(--cyan));
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.panel-footer {
  padding: 12px 18px;
  border-top: 1px solid var(--border-dim);
  background: linear-gradient(0deg, rgba(0,0,0,0.2) 0%, transparent 100%);
}

.score-section {
  display: flex;
  align-items: center;
  gap: 12px;
}

.score-label {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dim);
  width: 50px;
  flex-shrink: 0;
}

.score-bar-track {
  flex: 1;
  height: 6px;
  background: var(--bg-deep);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.score-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 1s cubic-bezier(0.4, 0, 0.2, 1), background 0.5s ease;
  width: 0%;
  position: relative;
}

.score-bar-fill::after {
  content: '';
  position: absolute;
  right: 0;
  top: -2px;
  bottom: -2px;
  width: 4px;
  background: inherit;
  border-radius: 2px;
  box-shadow: 0 0 8px currentColor;
}

.score-value {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--text-primary);
  width: 36px;
  text-align: right;
  flex-shrink: 0;
}

/* --- Syntax Highlighting --- */
.syn-keyword { color: #00d4ff; font-weight: 500; }
.syn-string { color: #00ff88; }
.syn-comment { color: #555e6b; font-style: italic; }
.syn-number { color: #ff9e44; }
.syn-decorator { color: #ff00aa; }
.syn-builtin { color: #e0a0ff; }
.syn-operator { color: #8b949e; }
.syn-function { color: #dcdcaa; }
.syn-class-name { color: #4ec9b0; }
.syn-punctuation { color: #6a737d; }

/* --- Sidebar --- */
#sidebar {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.sidebar-card {
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.sidebar-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border-dim);
  display: flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
}

.sidebar-header h3 {
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-secondary);
}

.sidebar-header .icon {
  color: var(--cyan);
  font-size: 1rem;
}

/* --- Leaderboard --- */
.leaderboard-list {
  padding: 8px 0;
}

.leaderboard-entry {
  display: grid;
  grid-template-columns: 28px 1fr auto;
  align-items: center;
  gap: 12px;
  padding: 10px 18px;
  transition: var(--transition);
  cursor: default;
}

.leaderboard-entry:hover {
  background: var(--bg-card-hover);
}

.leaderboard-rank {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 0.85rem;
  color: var(--text-dim);
  text-align: center;
}

.leaderboard-entry:nth-child(1) .leaderboard-rank { color: var(--yellow); text-shadow: 0 0 8px var(--yellow-dim); }
.leaderboard-entry:nth-child(2) .leaderboard-rank { color: var(--text-secondary); }
.leaderboard-entry:nth-child(3) .leaderboard-rank { color: #cd7f32; }

.leaderboard-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.leaderboard-name {
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--entry-color, var(--text-primary));
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.leaderboard-stats {
  font-size: 0.7rem;
  color: var(--text-dim);
  font-family: var(--font-mono);
}

.leaderboard-elo {
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 1rem;
  color: var(--entry-color, var(--text-primary));
  text-shadow: 0 0 10px var(--entry-color-dim, transparent);
}

.leaderboard-bar {
  grid-column: 1 / -1;
  height: 3px;
  background: var(--bg-deep);
  border-radius: 2px;
  margin: 0 18px 4px;
  overflow: hidden;
}

.leaderboard-bar-fill {
  height: 100%;
  border-radius: 2px;
  background: var(--entry-color, var(--text-dim));
  transition: width 1s ease;
  opacity: 0.5;
}

.leaderboard-empty {
  padding: 30px 18px;
  text-align: center;
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 0.8rem;
}

/* --- History --- */
.history-list {
  max-height: 300px;
  overflow-y: auto;
}

.history-entry {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 18px;
  cursor: pointer;
  transition: var(--transition);
  border-bottom: 1px solid var(--border-dim);
}

.history-entry:last-child {
  border-bottom: none;
}

.history-entry:hover {
  background: var(--bg-card-hover);
}

.history-status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.history-status-dot.completed { background: var(--green); box-shadow: 0 0 6px var(--green-dim); }
.history-status-dot.running { background: var(--cyan); box-shadow: 0 0 6px var(--cyan-dim); animation: pulse-glow 1.5s ease-in-out infinite; }
.history-status-dot.failed { background: #ff4444; box-shadow: 0 0 6px #ff444440; }
.history-status-dot.pending { background: var(--text-dim); }

.history-info {
  flex: 1;
  min-width: 0;
}

.history-title {
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.history-meta {
  font-size: 0.7rem;
  color: var(--text-dim);
  font-family: var(--font-mono);
}

.history-empty {
  padding: 30px 18px;
  text-align: center;
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 0.8rem;
}

/* --- Reviews Panel --- */
#reviews-panel {
  margin-bottom: 24px;
}

.reviews-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.reviews-header h2 {
  font-size: 1rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-secondary);
}

.reviews-header .icon {
  color: var(--yellow);
}

.reviews-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 16px;
}

.review-card {
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: var(--transition);
  animation: slide-up 0.4s ease both;
}

.review-card:hover {
  border-color: var(--border-glow);
  transform: translateY(-2px);
}

.review-card-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border-dim);
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
}

.review-card-header .reviewer-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.reviewer-badge {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 3px 8px;
  border-radius: 4px;
  background: var(--accent-dim);
  color: var(--accent);
  border: 1px solid var(--accent);
}

.review-arrow {
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: 4px;
  background: var(--bg-deep);
}

.review-target {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.review-score-badge {
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 1.1rem;
  color: var(--text-primary);
}

.review-card-body {
  padding: 14px 18px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, padding 0.4s ease;
}

.review-card.expanded .review-card-body {
  max-height: 400px;
  padding: 14px 18px;
}

.review-section {
  margin-bottom: 12px;
}

.review-section:last-child {
  margin-bottom: 0;
}

.review-section-title {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.review-section ul {
  list-style: none;
  padding: 0;
}

.review-section li {
  font-size: 0.8rem;
  color: var(--text-primary);
  padding: 3px 0;
  padding-left: 16px;
  position: relative;
  line-height: 1.5;
}

.review-section li::before {
  content: '';
  position: absolute;
  left: 0;
  top: 10px;
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.review-section.strengths li::before {
  background: var(--green);
  box-shadow: 0 0 4px var(--green-dim);
}

.review-section.weaknesses li::before {
  background: var(--magenta);
  box-shadow: 0 0 4px var(--magenta-dim);
}

/* --- Verdict Banner --- */
#verdict-banner {
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-lg);
  margin-bottom: 24px;
  overflow: hidden;
  position: relative;
  animation: slide-up 0.6s ease both;
}

#verdict-banner.hidden {
  display: none;
}

.verdict-particles {
  position: absolute;
  inset: 0;
  overflow: hidden;
  pointer-events: none;
}

.verdict-particle {
  position: absolute;
  width: 4px;
  height: 12px;
  border-radius: 2px;
  top: -20px;
  animation: confetti-fall linear forwards;
}

.verdict-content {
  position: relative;
  z-index: 2;
  padding: 32px;
  text-align: center;
}

.verdict-label {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 4px;
  color: var(--text-dim);
  margin-bottom: 12px;
}

.verdict-winner {
  font-family: var(--font-mono);
  font-size: 2.2rem;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 6px;
  margin-bottom: 8px;
}

.verdict-reason {
  font-size: 0.9rem;
  color: var(--text-secondary);
  max-width: 600px;
  margin: 0 auto 24px;
  line-height: 1.6;
}

.verdict-code-container {
  background: var(--bg-deep);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius);
  padding: 20px;
  max-width: 700px;
  margin: 0 auto;
  text-align: left;
  max-height: 400px;
  overflow: auto;
}

.verdict-code-container pre {
  font-family: var(--font-mono);
  font-size: 0.82rem;
  line-height: 1.7;
  white-space: pre;
}

/* --- Activity Log --- */
#activity-log {
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.log-header {
  padding: 12px 18px;
  border-bottom: 1px solid var(--border-dim);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
}

.log-header h3 {
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.log-header .icon {
  color: var(--green);
}

.log-clear-btn {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  background: none;
  border: 1px solid var(--border-dim);
  border-radius: 4px;
  padding: 4px 10px;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: var(--transition);
}

.log-clear-btn:hover {
  color: var(--text-secondary);
  border-color: var(--border-glow);
}

.log-body {
  padding: 4px 0;
  max-height: 200px;
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: 0.75rem;
}

.log-entry {
  display: flex;
  gap: 12px;
  padding: 5px 18px;
  transition: background 0.15s ease;
  align-items: flex-start;
}

.log-entry:hover {
  background: var(--bg-card-hover);
}

.log-timestamp {
  color: var(--text-dim);
  flex-shrink: 0;
  font-size: 0.7rem;
  padding-top: 1px;
}

.log-message {
  color: var(--text-secondary);
  line-height: 1.5;
  word-break: break-word;
}

.log-message .highlight {
  font-weight: 600;
}

.log-message .hl-cyan { color: var(--cyan); }
.log-message .hl-magenta { color: var(--magenta); }
.log-message .hl-yellow { color: var(--yellow); }
.log-message .hl-green { color: var(--green); }
.log-message .hl-red { color: #ff4444; }

.log-empty {
  padding: 20px 18px;
  text-align: center;
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 0.75rem;
}

/* --- Toast Notifications --- */
#toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  padding: 12px 20px;
  border-radius: var(--radius);
  background: var(--bg-card);
  border: 1px solid var(--border-dim);
  color: var(--text-primary);
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  animation: toast-in 0.3s ease both;
  max-width: 360px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.toast.removing {
  animation: toast-out 0.3s ease both;
}

.toast.error {
  border-color: #ff4444;
  background: linear-gradient(135deg, var(--bg-card), #ff444410);
}

.toast.success {
  border-color: var(--green);
  background: linear-gradient(135deg, var(--bg-card), #00ff8810);
}

.toast.info {
  border-color: var(--cyan);
  background: linear-gradient(135deg, var(--bg-card), #00f0ff10);
}

.toast-icon {
  font-size: 1.1rem;
  flex-shrink: 0;
}

/* --- Responsive --- */
@media (max-width: 1200px) {
  #arena-container {
    grid-template-columns: 1fr;
  }

  #arena {
    grid-template-columns: 1fr;
  }

  #sidebar {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .reviews-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  html { font-size: 13px; }
  #app { padding: 0 12px 12px; }

  .logo { font-size: 1.8rem; letter-spacing: 4px; }
  .subtitle { display: none; }

  .form-body {
    grid-template-columns: 1fr;
  }

  #sidebar {
    grid-template-columns: 1fr;
  }

  .verdict-winner {
    font-size: 1.5rem;
    letter-spacing: 3px;
  }
}

/* --- Utility --- */
.hidden { display: none !important; }
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border: 0;
}
</style>
</head>
<body>

<div id="toast-container" aria-live="polite"></div>

<div id="app">
  <!-- ===== Top Bar ===== -->
  <header id="topbar" role="banner">
    <div class="logo-group">
      <h1 class="logo">FORGE</h1>
      <span class="subtitle">Multi-Model Adversarial Code Arena</span>
    </div>
    <div class="connection-status">
      <div class="status-dot" id="conn-dot" title="Connection status"></div>
      <span id="conn-label">OFFLINE</span>
    </div>
  </header>

  <!-- ===== Challenge Form ===== -->
  <section id="challenge-form" role="form" aria-label="New Challenge">
    <div class="form-header" onclick="toggleForm()" tabindex="0" role="button" aria-expanded="true" aria-controls="form-body" onkeydown="if(event.key==='Enter'||event.key===' ')toggleForm()">
      <h2><span class="icon" aria-hidden="true">&#9889;</span> New Challenge</h2>
      <span class="form-toggle" id="form-toggle" aria-hidden="true">&#9660;</span>
    </div>
    <div class="form-body" id="form-body">
      <div class="form-group">
        <label for="challenge-title">Title</label>
        <input type="text" id="challenge-title" placeholder="e.g., Thread-safe LRU Cache" autocomplete="off">
      </div>
      <div class="form-group">
        <label for="challenge-lang">Language</label>
        <select id="challenge-lang">
          <option value="python" selected>Python</option>
          <option value="javascript">JavaScript</option>
          <option value="rust">Rust</option>
          <option value="go">Go</option>
        </select>
      </div>
      <div class="form-group full-width">
        <label for="challenge-desc">Description</label>
        <textarea id="challenge-desc" placeholder="Describe the coding challenge in detail..."></textarea>
      </div>
      <div class="form-group full-width">
        <label for="challenge-tests">Test Code</label>
        <textarea id="challenge-tests" placeholder="# Write test code to verify solutions..."></textarea>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="fillDemo()" type="button">Demo</button>
        <button class="btn btn-primary" id="submit-btn" onclick="submitChallenge()" type="button">
          &#9876; Ignite Forge
        </button>
      </div>
    </div>
  </section>

  <!-- ===== Arena + Sidebar ===== -->
  <main id="arena-container">
    <div id="arena" role="region" aria-label="Battle Arena">
      <!-- Architect Panel -->
      <div class="solution-panel" data-perspective="architect">
        <div class="panel-header">
          <div class="panel-identity">
            <div class="panel-icon" aria-hidden="true">&#9679;</div>
            <span class="panel-name">Architect</span>
          </div>
          <div class="panel-status waiting" data-status="waiting">
            <span class="status-indicator"></span>
            <span class="status-text">Waiting</span>
          </div>
        </div>
        <div class="panel-code">
          <div class="placeholder">
            <div class="placeholder-icon" aria-hidden="true">&#9635;</div>
            <span>Awaiting challenge...</span>
          </div>
        </div>
        <div class="panel-footer">
          <div class="score-section">
            <span class="score-label">Score</span>
            <div class="score-bar-track"><div class="score-bar-fill"></div></div>
            <span class="score-value">--</span>
          </div>
        </div>
      </div>

      <!-- Hacker Panel -->
      <div class="solution-panel" data-perspective="hacker">
        <div class="panel-header">
          <div class="panel-identity">
            <div class="panel-icon" aria-hidden="true">&#9760;</div>
            <span class="panel-name">Hacker</span>
          </div>
          <div class="panel-status waiting" data-status="waiting">
            <span class="status-indicator"></span>
            <span class="status-text">Waiting</span>
          </div>
        </div>
        <div class="panel-code">
          <div class="placeholder">
            <div class="placeholder-icon" aria-hidden="true">&#9760;</div>
            <span>Awaiting challenge...</span>
          </div>
        </div>
        <div class="panel-footer">
          <div class="score-section">
            <span class="score-label">Score</span>
            <div class="score-bar-track"><div class="score-bar-fill"></div></div>
            <span class="score-value">--</span>
          </div>
        </div>
      </div>

      <!-- Scientist Panel -->
      <div class="solution-panel" data-perspective="scientist">
        <div class="panel-header">
          <div class="panel-identity">
            <div class="panel-icon" aria-hidden="true">&#9878;</div>
            <span class="panel-name">Scientist</span>
          </div>
          <div class="panel-status waiting" data-status="waiting">
            <span class="status-indicator"></span>
            <span class="status-text">Waiting</span>
          </div>
        </div>
        <div class="panel-code">
          <div class="placeholder">
            <div class="placeholder-icon" aria-hidden="true">&#9878;</div>
            <span>Awaiting challenge...</span>
          </div>
        </div>
        <div class="panel-footer">
          <div class="score-section">
            <span class="score-label">Score</span>
            <div class="score-bar-track"><div class="score-bar-fill"></div></div>
            <span class="score-value">--</span>
          </div>
        </div>
      </div>

      <!-- Pragmatist Panel -->
      <div class="solution-panel" data-perspective="pragmatist">
        <div class="panel-header">
          <div class="panel-identity">
            <div class="panel-icon" aria-hidden="true">&#9881;</div>
            <span class="panel-name">Pragmatist</span>
          </div>
          <div class="panel-status waiting" data-status="waiting">
            <span class="status-indicator"></span>
            <span class="status-text">Waiting</span>
          </div>
        </div>
        <div class="panel-code">
          <div class="placeholder">
            <div class="placeholder-icon" aria-hidden="true">&#9881;</div>
            <span>Awaiting challenge...</span>
          </div>
        </div>
        <div class="panel-footer">
          <div class="score-section">
            <span class="score-label">Score</span>
            <div class="score-bar-track"><div class="score-bar-fill"></div></div>
            <span class="score-value">--</span>
          </div>
        </div>
      </div>

      <!-- VS Badge -->
      <div id="vs-badge" aria-hidden="true">VS</div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" aria-label="Sidebar">
      <div class="sidebar-card" id="leaderboard">
        <div class="sidebar-header">
          <span class="icon" aria-hidden="true">&#9733;</span>
          <h3>ELO Leaderboard</h3>
        </div>
        <div class="leaderboard-list" id="leaderboard-list">
          <div class="leaderboard-empty">No battles yet. Ignite a challenge.</div>
        </div>
      </div>

      <div class="sidebar-card" id="history">
        <div class="sidebar-header">
          <span class="icon" aria-hidden="true">&#9776;</span>
          <h3>Challenge History</h3>
        </div>
        <div class="history-list" id="history-list">
          <div class="history-empty">No challenges recorded.</div>
        </div>
      </div>
    </aside>
  </main>

  <!-- ===== Reviews Panel ===== -->
  <section id="reviews-panel" aria-label="Reviews">
    <div class="reviews-header">
      <span class="icon" aria-hidden="true">&#9733;</span>
      <h2>Battle Reviews</h2>
    </div>
    <div class="reviews-grid" id="reviews-grid"></div>
  </section>

  <!-- ===== Verdict Banner ===== -->
  <section id="verdict-banner" class="hidden" aria-label="Verdict" role="alert">
    <div class="verdict-particles" id="verdict-particles"></div>
    <div class="verdict-content">
      <div class="verdict-label">Forge Complete</div>
      <div class="verdict-winner" id="verdict-winner"></div>
      <div class="verdict-reason" id="verdict-reason"></div>
      <div class="verdict-code-container">
        <pre id="verdict-code"></pre>
      </div>
    </div>
  </section>

  <!-- ===== Activity Log ===== -->
  <footer id="activity-log" role="log" aria-label="Activity Log">
    <div class="log-header">
      <h3><span class="icon" aria-hidden="true">&#9654;</span> Activity Log</h3>
      <button class="log-clear-btn" onclick="clearLog()">Clear</button>
    </div>
    <div class="log-body" id="log-body">
      <div class="log-empty" id="log-empty">Waiting for activity...</div>
    </div>
  </footer>
</div>

<script>
/* ==============================================================
   FORGE Dashboard - JavaScript Engine
   ==============================================================*/

// --- State ---
const state = {
  currentChallengeId: null,
  eventSource: null,
  reconnectAttempts: 0,
  maxReconnectAttempts: 10,
  reconnectTimeout: null,
  challenges: [],
  leaderboard: [],
  reviews: [],
  panelScores: {}
};

const PERSPECTIVE_COLORS = {
  architect: { color: '#00f0ff', dim: '#00f0ff40', label: 'Architect' },
  hacker:    { color: '#ff00aa', dim: '#ff00aa40', label: 'Hacker' },
  scientist: { color: '#f0ff00', dim: '#f0ff0040', label: 'Scientist' },
  pragmatist:{ color: '#00ff88', dim: '#00ff8840', label: 'Pragmatist' }
};

const PERSPECTIVE_ICONS = {
  architect: '\u25CF',
  hacker:    '\u2620',
  scientist: '\u2696',
  pragmatist:'\u2699'
};

// --- Toast Notifications ---
function showToast(message, type = 'info', duration = 4000) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  const icons = { error: '\u26A0', success: '\u2713', info: '\u24D8' };
  toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span>${escapeHtml(message)}</span>`;

  container.appendChild(toast);

  setTimeout(() => {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// --- Utilities ---
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatTime(date) {
  const d = date instanceof Date ? date : new Date(date);
  return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function relativeTime(dateStr) {
  const now = Date.now();
  const then = new Date(dateStr).getTime();
  const diff = Math.floor((now - then) / 1000);
  if (diff < 60) return `${diff}s ago`;
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  return `${Math.floor(diff / 86400)}d ago`;
}

// --- Syntax Highlighting ---
function highlightSyntax(code, language) {
  if (!code) return '';
  let html = escapeHtml(code);

  if (language === 'python' || !language) {
    // Order matters: comments and strings first to avoid highlighting inside them
    // We tokenize to avoid double-processing

    const tokens = [];
    let i = 0;
    const src = code;

    while (i < src.length) {
      // Comments
      if (src[i] === '#') {
        let end = src.indexOf('\n', i);
        if (end === -1) end = src.length;
        tokens.push({ type: 'comment', text: src.slice(i, end) });
        i = end;
        continue;
      }

      // Triple-quoted strings
      if ((src.slice(i, i + 3) === '"""' || src.slice(i, i + 3) === "'''")) {
        const quote = src.slice(i, i + 3);
        let end = src.indexOf(quote, i + 3);
        if (end === -1) end = src.length; else end += 3;
        tokens.push({ type: 'string', text: src.slice(i, end) });
        i = end;
        continue;
      }

      // Single/double quoted strings
      if (src[i] === '"' || src[i] === "'") {
        const quote = src[i];
        let j = i + 1;
        while (j < src.length && src[j] !== quote) {
          if (src[j] === '\\') j++;
          j++;
        }
        j = Math.min(j + 1, src.length);
        tokens.push({ type: 'string', text: src.slice(i, j) });
        i = j;
        continue;
      }

      // Decorators
      if (src[i] === '@' && (i === 0 || src[i - 1] === '\n' || /\s/.test(src[i - 1]))) {
        let j = i + 1;
        while (j < src.length && /[\w.]/.test(src[j])) j++;
        tokens.push({ type: 'decorator', text: src.slice(i, j) });
        i = j;
        continue;
      }

      // Numbers
      if (/\d/.test(src[i]) && (i === 0 || /[\s(=,[\{:+\-*/<>!]/.test(src[i - 1]))) {
        let j = i;
        while (j < src.length && /[\d._xXoObBeE]/.test(src[j])) j++;
        tokens.push({ type: 'number', text: src.slice(i, j) });
        i = j;
        continue;
      }

      // Words (identifiers, keywords)
      if (/[a-zA-Z_]/.test(src[i])) {
        let j = i;
        while (j < src.length && /[\w]/.test(src[j])) j++;
        const word = src.slice(i, j);
        const keywords = ['def', 'class', 'return', 'if', 'elif', 'else', 'for', 'while', 'import', 'from',
                          'with', 'as', 'try', 'except', 'finally', 'raise', 'True', 'False', 'None',
                          'async', 'await', 'yield', 'in', 'is', 'not', 'and', 'or', 'lambda',
                          'pass', 'break', 'continue', 'del', 'assert', 'global', 'nonlocal'];
        const builtins = ['print', 'len', 'range', 'int', 'str', 'float', 'list', 'dict', 'set',
                         'tuple', 'bool', 'type', 'isinstance', 'super', 'property',
                         'staticmethod', 'classmethod', 'enumerate', 'zip', 'map', 'filter',
                         'sorted', 'reversed', 'any', 'all', 'min', 'max', 'sum', 'abs',
                         'hasattr', 'getattr', 'setattr', 'callable', 'iter', 'next',
                         'open', 'input', 'repr', 'hash', 'id', 'vars', 'dir',
                         'Exception', 'ValueError', 'TypeError', 'KeyError', 'IndexError',
                         'RuntimeError', 'StopIteration', 'AttributeError', 'NotImplementedError',
                         'OSError', 'IOError', 'FileNotFoundError'];

        if (keywords.includes(word)) {
          tokens.push({ type: 'keyword', text: word });
        } else if (builtins.includes(word)) {
          tokens.push({ type: 'builtin', text: word });
        } else if (i > 0 && /(?:def|class)\s+$/.test(src.slice(Math.max(0, i - 10), i))) {
          tokens.push({ type: word === word && src.slice(Math.max(0, i - 6), i).trimEnd().endsWith('class') ? 'class-name' : 'function', text: word });
        } else {
          tokens.push({ type: 'plain', text: word });
        }
        i = j;
        continue;
      }

      // Operators / punctuation
      tokens.push({ type: 'plain', text: src[i] });
      i++;
    }

    // Render tokens
    const parts = tokens.map(t => {
      const escaped = escapeHtml(t.text);
      switch (t.type) {
        case 'keyword':   return `<span class="syn-keyword">${escaped}</span>`;
        case 'string':    return `<span class="syn-string">${escaped}</span>`;
        case 'comment':   return `<span class="syn-comment">${escaped}</span>`;
        case 'number':    return `<span class="syn-number">${escaped}</span>`;
        case 'decorator': return `<span class="syn-decorator">${escaped}</span>`;
        case 'builtin':   return `<span class="syn-builtin">${escaped}</span>`;
        case 'function':  return `<span class="syn-function">${escaped}</span>`;
        case 'class-name':return `<span class="syn-class-name">${escaped}</span>`;
        default:          return escaped;
      }
    });
    return parts.join('');
  }

  // Fallback for other languages: basic keyword + string + comment highlighting
  // Strings
  html = html.replace(/(["'`])(?:(?!\1|\\).|\\.)*\1/g, '<span class="syn-string">$&</span>');
  // Line comments (// and #)
  html = html.replace(/(\/\/.*?$|#.*?$)/gm, '<span class="syn-comment">$&</span>');
  // Numbers
  html = html.replace(/\b(\d+\.?\d*)\b/g, '<span class="syn-number">$1</span>');

  if (language === 'javascript') {
    const jsKeywords = /\b(const|let|var|function|return|if|else|for|while|class|extends|import|export|from|async|await|new|this|try|catch|throw|finally|switch|case|break|continue|default|yield|of|in|typeof|instanceof)\b/g;
    html = html.replace(jsKeywords, '<span class="syn-keyword">$1</span>');
  } else if (language === 'rust') {
    const rustKeywords = /\b(fn|let|mut|pub|struct|enum|impl|trait|use|mod|self|Self|match|if|else|for|while|loop|return|async|await|move|where|type|const|static|ref|unsafe|extern|crate|super)\b/g;
    html = html.replace(rustKeywords, '<span class="syn-keyword">$1</span>');
  } else if (language === 'go') {
    const goKeywords = /\b(func|package|import|var|const|type|struct|interface|return|if|else|for|range|switch|case|break|continue|default|go|chan|select|defer|map|make|new|append|len|cap|error|nil)\b/g;
    html = html.replace(goKeywords, '<span class="syn-keyword">$1</span>');
  }

  return html;
}

// --- Form Toggle ---
function toggleForm() {
  const body = document.getElementById('form-body');
  const toggle = document.getElementById('form-toggle');
  const header = document.querySelector('.form-header');

  body.classList.toggle('collapsed');
  toggle.classList.toggle('collapsed');
  header.setAttribute('aria-expanded', !body.classList.contains('collapsed'));
}

// --- Demo Fill ---
function fillDemo() {
  document.getElementById('challenge-title').value = 'Thread-Safe LRU Cache';
  document.getElementById('challenge-lang').value = 'python';
  document.getElementById('challenge-desc').value = `Implement a thread-safe LRU (Least Recently Used) cache with the following requirements:

1. Support get(key) and put(key, value) operations in O(1) time complexity
2. Thread-safe for concurrent access using locks
3. Configurable maximum capacity
4. Evict least recently used entries when capacity is exceeded
5. Support an optional TTL (time-to-live) for cache entries
6. Implement as a class called ThreadSafeLRUCache`;
  document.getElementById('challenge-tests').value = `import threading
import time

def test_basic_operations():
    cache = ThreadSafeLRUCache(capacity=3)
    cache.put("a", 1)
    cache.put("b", 2)
    cache.put("c", 3)
    assert cache.get("a") == 1
    assert cache.get("d") is None

def test_eviction():
    cache = ThreadSafeLRUCache(capacity=2)
    cache.put("a", 1)
    cache.put("b", 2)
    cache.put("c", 3)  # should evict "a"
    assert cache.get("a") is None
    assert cache.get("b") == 2

def test_thread_safety():
    cache = ThreadSafeLRUCache(capacity=100)
    errors = []
    def writer(start):
        for i in range(start, start + 50):
            cache.put(f"key_{i}", i)
    threads = [threading.Thread(target=writer, args=(i*50,)) for i in range(4)]
    for t in threads: t.start()
    for t in threads: t.join()
    count = sum(1 for i in range(200) if cache.get(f"key_{i}") is not None)
    assert count == 100  # capacity limit respected

def test_ttl():
    cache = ThreadSafeLRUCache(capacity=10, default_ttl=0.1)
    cache.put("x", 42)
    assert cache.get("x") == 42
    time.sleep(0.15)
    assert cache.get("x") is None  # expired`;

  logEvent('Demo challenge loaded', 'hl-cyan');
  showToast('Demo challenge loaded', 'info');
}

// --- Logging ---
function logEvent(message, hlClass) {
  const logBody = document.getElementById('log-body');
  const empty = document.getElementById('log-empty');
  if (empty) empty.remove();

  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = `
    <span class="log-timestamp">${formatTime(new Date())}</span>
    <span class="log-message"><span class="highlight ${hlClass || ''}">${message}</span></span>
  `;
  logBody.appendChild(entry);
  logBody.scrollTop = logBody.scrollHeight;
}

function clearLog() {
  const logBody = document.getElementById('log-body');
  logBody.innerHTML = '<div class="log-empty" id="log-empty">Log cleared.</div>';
}

// --- Score Bar ---
function updateScoreBar(panel, score) {
  const fill = panel.querySelector('.score-bar-fill');
  const value = panel.querySelector('.score-value');
  const pct = Math.max(0, Math.min(100, (score / 10) * 100));

  // Color gradient: red -> yellow -> green
  let color;
  if (score <= 3) {
    color = '#ff4444';
  } else if (score <= 5) {
    const t = (score - 3) / 2;
    color = `hsl(${t * 60}, 100%, 50%)`;
  } else if (score <= 7) {
    const t = (score - 5) / 2;
    color = `hsl(${60 + t * 30}, 100%, 50%)`;
  } else {
    color = '#00ff88';
  }

  fill.style.width = pct + '%';
  fill.style.background = color;
  fill.style.color = color;
  value.textContent = score.toFixed(1);
}

// --- Panel Status ---
function setPanelStatus(perspective, status) {
  const panel = document.querySelector(`.solution-panel[data-perspective="${perspective}"]`);
  if (!panel) return;

  const statusEl = panel.querySelector('.panel-status');
  const textEl = statusEl.querySelector('.status-text');

  statusEl.className = `panel-status ${status}`;
  statusEl.dataset.status = status;

  const labels = {
    waiting: 'Waiting',
    generating: 'Generating',
    reviewing: 'Reviewing',
    done: 'Done',
    error: 'Error'
  };
  textEl.textContent = labels[status] || status;

  panel.classList.remove('generating');
  if (status === 'generating') {
    panel.classList.add('generating');
  }
}

// --- Panel Code ---
function setPanelCode(perspective, code, language) {
  const panel = document.querySelector(`.solution-panel[data-perspective="${perspective}"]`);
  if (!panel) return;

  const codeContainer = panel.querySelector('.panel-code');
  const highlighted = highlightSyntax(code, language);
  codeContainer.innerHTML = `<pre>${highlighted}</pre>`;
  codeContainer.style.animation = 'fade-in 0.5s ease both';
}

// --- Reset Arena ---
function resetArena() {
  const perspectives = ['architect', 'hacker', 'scientist', 'pragmatist'];
  perspectives.forEach(p => {
    setPanelStatus(p, 'waiting');
    const panel = document.querySelector(`.solution-panel[data-perspective="${p}"]`);
    if (panel) {
      panel.classList.remove('winner', 'generating');
      const codeEl = panel.querySelector('.panel-code');
      const icon = PERSPECTIVE_ICONS[p] || '\u25CF';
      codeEl.innerHTML = `<div class="placeholder"><div class="placeholder-icon">${icon}</div><span>Awaiting challenge...</span></div>`;
      const fill = panel.querySelector('.score-bar-fill');
      const val = panel.querySelector('.score-value');
      fill.style.width = '0%';
      val.textContent = '--';
    }
  });

  document.getElementById('vs-badge').classList.remove('active');
  document.getElementById('verdict-banner').classList.add('hidden');
  document.getElementById('reviews-grid').innerHTML = '';
  state.reviews = [];
  state.panelScores = {};
}

// --- Submit Challenge ---
async function submitChallenge() {
  const title = document.getElementById('challenge-title').value.trim();
  const description = document.getElementById('challenge-desc').value.trim();
  const language = document.getElementById('challenge-lang').value;
  const test_code = document.getElementById('challenge-tests').value.trim();

  if (!title) {
    showToast('Title is required', 'error');
    document.getElementById('challenge-title').focus();
    return;
  }
  if (!description) {
    showToast('Description is required', 'error');
    document.getElementById('challenge-desc').focus();
    return;
  }

  const btn = document.getElementById('submit-btn');
  btn.classList.add('loading');
  btn.disabled = true;

  try {
    logEvent(`Submitting challenge: <span class="hl-cyan">${escapeHtml(title)}</span>`, '');

    const response = await fetch('/api/challenges', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, description, language, test_code })
    });

    if (!response.ok) {
      const errData = await response.json().catch(() => ({ detail: 'Unknown error' }));
      throw new Error(errData.detail || `HTTP ${response.status}`);
    }

    const data = await response.json();
    const challengeId = data.challenge?.id || data.id;

    if (!challengeId) throw new Error('No challenge ID returned');

    state.currentChallengeId = challengeId;
    resetArena();
    logEvent(`Challenge created: <span class="hl-green">#${challengeId}</span>`, '');
    showToast('Forge ignited!', 'success');

    // Collapse form
    const body = document.getElementById('form-body');
    if (!body.classList.contains('collapsed')) toggleForm();

    // Connect SSE
    connectSSE(challengeId);

    // Refresh history
    loadChallenges();

  } catch (err) {
    logEvent(`Error: <span class="hl-red">${escapeHtml(err.message)}</span>`, '');
    showToast(err.message, 'error');
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// --- SSE Connection ---
function connectSSE(challengeId) {
  if (state.eventSource) {
    state.eventSource.close();
    state.eventSource = null;
  }

  const url = `/api/challenges/${challengeId}/stream`;
  logEvent(`Connecting to event stream...`, 'hl-cyan');

  const es = new EventSource(url);
  state.eventSource = es;
  state.reconnectAttempts = 0;

  es.onopen = () => {
    setConnectionStatus('connected');
    logEvent('Stream connected', 'hl-green');
    state.reconnectAttempts = 0;
  };

  es.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      handleSSEEvent(data);
    } catch (err) {
      // Plain text event
      logEvent(event.data, 'hl-cyan');
    }
  };

  // Named event handlers
  const eventTypes = [
    'challenge_started', 'generation_started', 'solution_generated',
    'review_started', 'review_complete', 'voting_started', 'vote_result',
    'verification_started', 'verification_complete',
    'forge_complete', 'forge_error'
  ];

  eventTypes.forEach(type => {
    es.addEventListener(type, (event) => {
      try {
        const data = JSON.parse(event.data);
        handleSSEEvent({ type, ...data });
      } catch (err) {
        handleSSEEvent({ type, message: event.data });
      }
    });
  });

  es.onerror = () => {
    setConnectionStatus('disconnected');

    if (es.readyState === EventSource.CLOSED) {
      logEvent('Stream closed', 'hl-red');
      attemptReconnect(challengeId);
    }
  };
}

function attemptReconnect(challengeId) {
  if (state.reconnectAttempts >= state.maxReconnectAttempts) {
    logEvent('Max reconnection attempts reached', 'hl-red');
    showToast('Connection lost. Refresh to retry.', 'error', 8000);
    return;
  }

  state.reconnectAttempts++;
  const delay = Math.min(1000 * Math.pow(2, state.reconnectAttempts), 30000);
  logEvent(`Reconnecting in ${delay / 1000}s (attempt ${state.reconnectAttempts})...`, 'hl-yellow');

  clearTimeout(state.reconnectTimeout);
  state.reconnectTimeout = setTimeout(() => connectSSE(challengeId), delay);
}

function setConnectionStatus(status) {
  const dot = document.getElementById('conn-dot');
  const label = document.getElementById('conn-label');
  dot.className = `status-dot ${status}`;
  label.textContent = status === 'connected' ? 'LIVE' : 'OFFLINE';
}

// --- SSE Event Handler ---
function handleSSEEvent(data) {
  const type = data.type || data.event;
  const perspective = data.perspective;
  const pColor = perspective ? PERSPECTIVE_COLORS[perspective] : null;
  const pLabel = pColor ? pColor.label : perspective;
  const hlClass = perspective ? `hl-${perspective === 'architect' ? 'cyan' : perspective === 'hacker' ? 'magenta' : perspective === 'scientist' ? 'yellow' : 'green'}` : 'hl-cyan';

  switch (type) {
    case 'challenge_started':
      logEvent('Challenge started. Arena is live.', 'hl-green');
      document.getElementById('vs-badge').classList.add('active');
      break;

    case 'generation_started':
      setPanelStatus(perspective, 'generating');
      logEvent(`<span class="${hlClass}">${pLabel}</span> is generating a solution...`, '');
      // Show spinner in panel
      const genPanel = document.querySelector(`.solution-panel[data-perspective="${perspective}"] .panel-code`);
      if (genPanel) {
        genPanel.innerHTML = `<div class="placeholder"><div class="spinner"></div><span>Generating solution...</span></div>`;
      }
      break;

    case 'solution_generated':
      setPanelStatus(perspective, 'done');
      if (data.code) {
        setPanelCode(perspective, data.code, data.language || 'python');
      }
      logEvent(`<span class="${hlClass}">${pLabel}</span> solution ready`, '');
      break;

    case 'review_started':
      if (data.reviewer) {
        const rhlClass = `hl-${data.reviewer === 'architect' ? 'cyan' : data.reviewer === 'hacker' ? 'magenta' : data.reviewer === 'scientist' ? 'yellow' : 'green'}`;
        logEvent(`<span class="${rhlClass}">${PERSPECTIVE_COLORS[data.reviewer]?.label || data.reviewer}</span> reviewing <span class="${hlClass}">${pLabel}</span>`, '');
      } else {
        setPanelStatus(perspective, 'reviewing');
        logEvent(`Reviewing <span class="${hlClass}">${pLabel}</span>...`, '');
      }
      break;

    case 'review_complete':
      addReviewCard(data);
      if (data.score !== undefined && perspective) {
        if (!state.panelScores[perspective]) state.panelScores[perspective] = [];
        state.panelScores[perspective].push(data.score);
        const avg = state.panelScores[perspective].reduce((a, b) => a + b, 0) / state.panelScores[perspective].length;
        const panel = document.querySelector(`.solution-panel[data-perspective="${perspective}"]`);
        if (panel) updateScoreBar(panel, avg);
      }
      logEvent(`Review complete: <span class="${hlClass}">${pLabel}</span> scored <span class="hl-yellow">${data.score?.toFixed?.(1) || data.score}</span>`, '');
      break;

    case 'voting_started':
      logEvent('Vote tallying in progress...', 'hl-yellow');
      break;

    case 'vote_result':
      if (data.scores) {
        Object.entries(data.scores).forEach(([p, score]) => {
          const panel = document.querySelector(`.solution-panel[data-perspective="${p}"]`);
          if (panel) updateScoreBar(panel, score);
        });
      }
      if (data.winner) {
        const whlClass = `hl-${data.winner === 'architect' ? 'cyan' : data.winner === 'hacker' ? 'magenta' : data.winner === 'scientist' ? 'yellow' : 'green'}`;
        logEvent(`Leading: <span class="${whlClass}">${PERSPECTIVE_COLORS[data.winner]?.label || data.winner}</span>`, '');
      }
      break;

    case 'verification_started':
      logEvent(`Verifying <span class="${hlClass}">${pLabel || 'solutions'}</span>...`, '');
      break;

    case 'verification_complete':
      const pass = data.passed || data.success;
      if (pass) {
        logEvent(`Verification <span class="hl-green">PASSED</span>${perspective ? ` for <span class="${hlClass}">${pLabel}</span>` : ''}`, '');
      } else {
        logEvent(`Verification <span class="hl-red">FAILED</span>${perspective ? ` for <span class="${hlClass}">${pLabel}</span>` : ''}: ${escapeHtml(data.output || data.error || '')}`, '');
      }
      break;

    case 'forge_complete':
      handleForgeComplete(data);
      break;

    case 'forge_error':
      logEvent(`<span class="hl-red">Forge error:</span> ${escapeHtml(data.message || data.error || 'Unknown error')}`, '');
      showToast(data.message || data.error || 'Forge error', 'error', 8000);
      document.getElementById('vs-badge').classList.remove('active');
      break;

    default:
      if (data.message) {
        logEvent(escapeHtml(data.message), 'hl-cyan');
      }
  }
}

// --- Forge Complete ---
function handleForgeComplete(data) {
  const winner = data.winner || data.winning_perspective;
  const wColor = PERSPECTIVE_COLORS[winner];
  const wLabel = wColor ? wColor.label : winner;
  const whlClass = winner ? `hl-${winner === 'architect' ? 'cyan' : winner === 'hacker' ? 'magenta' : winner === 'scientist' ? 'yellow' : 'green'}` : 'hl-green';

  logEvent(`FORGE COMPLETE. Winner: <span class="${whlClass}">${wLabel}</span>`, '');
  document.getElementById('vs-badge').classList.remove('active');

  // Mark winner panel
  if (winner) {
    const winPanel = document.querySelector(`.solution-panel[data-perspective="${winner}"]`);
    if (winPanel) winPanel.classList.add('winner');
  }

  // Show verdict
  const banner = document.getElementById('verdict-banner');
  const winnerEl = document.getElementById('verdict-winner');
  const reasonEl = document.getElementById('verdict-reason');
  const codeEl = document.getElementById('verdict-code');

  winnerEl.textContent = `${wLabel} Wins`;
  if (wColor) {
    winnerEl.style.color = wColor.color;
    winnerEl.style.textShadow = `0 0 30px ${wColor.dim}, 0 0 60px ${wColor.dim}`;
  }

  reasonEl.textContent = data.reason || data.summary || 'The forge has spoken.';

  if (data.winning_code || data.code) {
    codeEl.innerHTML = highlightSyntax(data.winning_code || data.code, data.language || 'python');
  } else {
    codeEl.innerHTML = '<span class="syn-comment"># Winning code not available in stream</span>';
  }

  banner.classList.remove('hidden');
  banner.scrollIntoView({ behavior: 'smooth', block: 'center' });

  // Confetti
  spawnConfetti(wColor ? wColor.color : '#00f0ff');

  // Refresh data
  loadStats();
  loadChallenges();

  // Close SSE
  if (state.eventSource) {
    state.eventSource.close();
    state.eventSource = null;
  }
  setConnectionStatus('disconnected');
}

// --- Confetti ---
function spawnConfetti(mainColor) {
  const container = document.getElementById('verdict-particles');
  container.innerHTML = '';

  const colors = [mainColor, '#00f0ff', '#ff00aa', '#f0ff00', '#00ff88', '#ffffff'];
  const count = 60;

  for (let i = 0; i < count; i++) {
    const particle = document.createElement('div');
    particle.className = 'verdict-particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
    particle.style.animationDuration = (2 + Math.random() * 3) + 's';
    particle.style.animationDelay = Math.random() * 1.5 + 's';
    particle.style.width = (2 + Math.random() * 4) + 'px';
    particle.style.height = (6 + Math.random() * 12) + 'px';
    particle.style.opacity = 0.6 + Math.random() * 0.4;
    container.appendChild(particle);
  }
}

// --- Review Cards ---
function addReviewCard(data) {
  const grid = document.getElementById('reviews-grid');
  const card = document.createElement('div');
  card.className = 'review-card';

  const reviewer = data.reviewer || 'unknown';
  const target = data.perspective || data.target || 'unknown';
  const score = data.score !== undefined ? (typeof data.score === 'number' ? data.score.toFixed(1) : data.score) : '?';
  const rColor = PERSPECTIVE_COLORS[reviewer];
  const tColor = PERSPECTIVE_COLORS[target];

  const strengths = data.strengths || [];
  const weaknesses = data.weaknesses || [];

  card.style.setProperty('--accent', rColor ? rColor.color : '#8b949e');
  card.style.setProperty('--accent-dim', rColor ? rColor.dim : '#8b949e40');

  card.innerHTML = `
    <div class="review-card-header" onclick="this.parentElement.classList.toggle('expanded')">
      <div class="reviewer-info">
        <span class="reviewer-badge" style="background: ${rColor ? rColor.dim : '#2a3040'}; color: ${rColor ? rColor.color : '#8b949e'}; border-color: ${rColor ? rColor.color + '40' : '#2a3040'}">
          ${escapeHtml(rColor ? rColor.label : reviewer)}
        </span>
        <span class="review-arrow">\u2192</span>
        <span class="review-target" style="color: ${tColor ? tColor.color : '#8b949e'}">
          ${escapeHtml(tColor ? tColor.label : target)}
        </span>
      </div>
      <span class="review-score-badge">${score}</span>
    </div>
    <div class="review-card-body">
      ${strengths.length > 0 ? `
        <div class="review-section strengths">
          <div class="review-section-title">Strengths</div>
          <ul>${strengths.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul>
        </div>
      ` : ''}
      ${weaknesses.length > 0 ? `
        <div class="review-section weaknesses">
          <div class="review-section-title">Weaknesses</div>
          <ul>${weaknesses.map(w => `<li>${escapeHtml(w)}</li>`).join('')}</ul>
        </div>
      ` : ''}
      ${!strengths.length && !weaknesses.length ? '<div style="color: var(--text-dim); font-size: 0.8rem;">No detailed review data available.</div>' : ''}
    </div>
  `;

  grid.appendChild(card);
  state.reviews.push(data);
}

// --- Leaderboard ---
function renderLeaderboard(stats) {
  const list = document.getElementById('leaderboard-list');

  if (!stats || !stats.length) {
    list.innerHTML = '<div class="leaderboard-empty">No battles yet. Ignite a challenge.</div>';
    return;
  }

  // Sort by ELO descending
  const sorted = [...stats].sort((a, b) => (b.elo || b.elo_rating || 1000) - (a.elo || a.elo_rating || 1000));
  const maxElo = Math.max(...sorted.map(s => s.elo || s.elo_rating || 1000));

  list.innerHTML = sorted.map((entry, i) => {
    const name = entry.perspective || entry.name;
    const pc = PERSPECTIVE_COLORS[name];
    const elo = entry.elo || entry.elo_rating || 1000;
    const wins = entry.wins || 0;
    const losses = entry.losses || 0;
    const draws = entry.draws || 0;
    const barWidth = maxElo > 0 ? (elo / (maxElo * 1.1)) * 100 : 0;

    return `
      <div class="leaderboard-entry" style="--entry-color: ${pc ? pc.color : '#8b949e'}; --entry-color-dim: ${pc ? pc.dim : 'transparent'}">
        <span class="leaderboard-rank">#${i + 1}</span>
        <div class="leaderboard-info">
          <span class="leaderboard-name">${escapeHtml(pc ? pc.label : name)}</span>
          <span class="leaderboard-stats">${wins}W / ${losses}L / ${draws}D</span>
        </div>
        <span class="leaderboard-elo">${elo}</span>
        <div class="leaderboard-bar">
          <div class="leaderboard-bar-fill" style="width: ${barWidth}%; background: ${pc ? pc.color : '#8b949e'}"></div>
        </div>
      </div>
    `;
  }).join('');
}

// --- Challenge History ---
function renderHistory(challenges) {
  const list = document.getElementById('history-list');

  if (!challenges || !challenges.length) {
    list.innerHTML = '<div class="history-empty">No challenges recorded.</div>';
    return;
  }

  // Most recent first
  const sorted = [...challenges].sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

  list.innerHTML = sorted.map(c => {
    const status = c.status || 'pending';
    const dotClass = status === 'completed' ? 'completed' : status === 'running' || status === 'in_progress' ? 'running' : status === 'failed' ? 'failed' : 'pending';
    const meta = c.created_at ? relativeTime(c.created_at) : '';
    const lang = c.language || '';

    return `
      <div class="history-entry" onclick="loadChallenge('${c.id}')" title="${escapeHtml(c.title || '')}">
        <div class="history-status-dot ${dotClass}"></div>
        <div class="history-info">
          <div class="history-title">${escapeHtml(c.title || `Challenge #${c.id}`)}</div>
          <div class="history-meta">${lang ? lang + ' \u00B7 ' : ''}${meta}</div>
        </div>
      </div>
    `;
  }).join('');
}

// --- Load Challenge ---
async function loadChallenge(id) {
  try {
    const res = await fetch(`/api/challenges/${id}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const challenge = data.challenge || data;

    state.currentChallengeId = id;
    resetArena();
    logEvent(`Loaded challenge <span class="hl-cyan">#${id}</span>: ${escapeHtml(challenge.title || '')}`, '');

    // Populate panels from existing data
    const solutions = challenge.solutions || data.solutions || [];
    solutions.forEach(sol => {
      const p = sol.perspective;
      if (sol.code) {
        setPanelCode(p, sol.code, challenge.language || 'python');
        setPanelStatus(p, 'done');
      }
    });

    // Populate reviews
    const reviews = challenge.reviews || data.reviews || [];
    document.getElementById('reviews-grid').innerHTML = '';
    state.reviews = [];
    reviews.forEach(r => addReviewCard(r));

    // Populate scores
    if (challenge.scores || data.scores) {
      const scores = challenge.scores || data.scores;
      Object.entries(scores).forEach(([p, score]) => {
        const panel = document.querySelector(`.solution-panel[data-perspective="${p}"]`);
        if (panel) updateScoreBar(panel, score);
      });
    }

    // Verdict
    const verdict = challenge.verdict || data.verdict;
    if (verdict && verdict.winner) {
      handleForgeComplete({
        winner: verdict.winner,
        reason: verdict.reason || verdict.summary,
        winning_code: verdict.code || verdict.winning_code,
        language: challenge.language
      });
    } else if (challenge.status === 'running' || challenge.status === 'in_progress') {
      // Connect to live stream
      connectSSE(id);
    }
  } catch (err) {
    showToast(`Failed to load challenge: ${err.message}`, 'error');
    logEvent(`Error loading challenge: <span class="hl-red">${escapeHtml(err.message)}</span>`, '');
  }
}

// --- API Loaders ---
async function loadChallenges() {
  try {
    const res = await fetch('/api/challenges');
    if (!res.ok) return;
    const data = await res.json();
    state.challenges = data.challenges || data || [];
    renderHistory(state.challenges);
  } catch (err) {
    // Silent  server may not be running
  }
}

async function loadStats() {
  try {
    const res = await fetch('/api/stats');
    if (!res.ok) return;
    const data = await res.json();
    state.leaderboard = data.leaderboard || data.perspectives || data || [];
    renderLeaderboard(state.leaderboard);
  } catch (err) {
    // Silent
  }
}

// --- Initialize ---
function init() {
  logEvent('FORGE dashboard initialized', 'hl-cyan');
  logEvent('System ready. Submit a challenge to begin.', 'hl-green');

  // Load existing data
  loadChallenges();
  loadStats();

  // Keyboard shortcut: Ctrl+Enter to submit
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      const form = document.getElementById('form-body');
      if (!form.classList.contains('collapsed')) {
        submitChallenge();
      }
    }
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
